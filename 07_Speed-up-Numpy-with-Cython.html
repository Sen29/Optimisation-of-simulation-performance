

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>7. How to speed up Numpy with Cython &#8212; Optimisation of simulation performance</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '07_Speed-up-Numpy-with-Cython';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. Speed up 2D particles with Cython" href="08_Speed-up-2D-particles-with-Cython.html" />
    <link rel="prev" title="6. Learn how to use cython" href="06_Learn-how-to-use-cython.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_Particles-motion-simulation%281D%29.html">1. One-dimensional particle motion simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Particles-motion-simulation%282D%29.html">2. Two-dimensional particle motion simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Particles-motion-simulation%28Lenaard-Jones-potential%29.html">3. Two-dimensional particle motion simulation_Lennard-Jones potential</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_NumPy-Optimization_Vectorization-and-Broadcasting.html">4. NumPy Optimization: Vectorization and Broadcasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_MKL.html">5. Trying to change the threads to improve Numpy’s efficiency</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_Learn-how-to-use-cython.html">6. Learn how to use cython</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">7. How to speed up Numpy with Cython</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_Speed-up-2D-particles-with-Cython.html">8. Speed up 2D particles with Cython</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_Methods%20of%20Inspection.html">9. Methods of Inspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="20_Performance-comparison_N250_Iteration1000.html">10. Performance comparison (Python &amp; Numpy &amp; Numba &amp; Cython &amp; C)</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/Sen29/Optimisation-of-simulation-performance/HEAD/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/07_Speed-up-Numpy-with-Cython.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2F07_Speed-up-Numpy-with-Cython.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/07_Speed-up-Numpy-with-Cython.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>How to speed up Numpy with Cython</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduce">7.1. Introduce</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-random-arrays">7.2. Generating random arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-code-for-the-nump">7.3. The code for the Nump</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-code-for-pure-python">7.4. The code for pure Python</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compare">7.4.1. Compare</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-code-for-cython">7.5. The code for Cython</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cython">7.5.1. Cython</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">7.5.1.1. Compare</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check">7.5.1.2. Check</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-types">7.5.2. Add Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#efficient-indexing-with-memoryviews">7.5.3. Efficient indexing with memoryviews</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tuning-indexing-further">7.5.4. Tuning indexing further</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declaring-the-numpy-arrays-as-contiguous">7.5.5. Declaring the NumPy arrays as contiguous</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-the-function-cleaner-use-of-multiple-data-types">7.5.6. Making the function cleaner &amp; Use of multiple data types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-multiple-threads">7.5.7. Using multiple threads</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summarize">7.6. Summarize</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#html-file">7.6.1. html file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">7.6.2. Compare</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="how-to-speed-up-numpy-with-cython">
<h1><span class="section-number">7. </span>How to speed up Numpy with Cython<a class="headerlink" href="#how-to-speed-up-numpy-with-cython" title="Permalink to this heading">#</a></h1>
<section id="introduce">
<h2><span class="section-number">7.1. </span>Introduce<a class="headerlink" href="#introduce" title="Permalink to this heading">#</a></h2>
<p><strong>This article will describe how to use Cython to speed up numpy.</strong></p>
<p>The original code using Nump is as follows, it truncates array_1 with the interval [2, 10] via np.clip. After that, we do some simple arithmetic with array_1, array_2 and a, b and c, and finally return the result of the calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_np</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="generating-random-arrays">
<h2><span class="section-number">7.2. </span>Generating random arrays<a class="headerlink" href="#generating-random-arrays" title="Permalink to this heading">#</a></h2>
<p><strong>This is the prefix for all the code below, please run this prefix before running the program below.</strong></p>
<p>It will generate two random two-dimensional arrays and set the values of a,b,c. To make it easier to compare the speed of the runs later, the dimension of the arrays generated here is set larger, to (3000x2000).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">array_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>
<span class="n">array_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">9</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-code-for-the-nump">
<h2><span class="section-number">7.3. </span>The code for the Nump<a class="headerlink" href="#the-code-for-the-nump" title="Permalink to this heading">#</a></h2>
<p><strong>The following code is executed by numpy.</strong></p>
<p>Here we name the function compute_np. We use timeit here to show how fast it runs, and to be more precise we calculate the average of its ten runs and record this length of time at the end with compute_np_time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">timeit</span>

<span class="k">def</span> <span class="nf">compute_np</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compute_np</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>

<span class="n">compute_np_time</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">compute_np</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;compute_np execution time:&quot;</span><span class="p">,</span> <span class="n">compute_np_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 85 127 241 ... 328  52 160]
 [196 160 343 ... 286 127 280]
 [169 109  94 ... 175 214 222]
 ...
 [253 163 325 ...  94 259 229]
 [133 308 190 ... 325 151 202]
 [178 331 281 ...  52 124 263]]
compute_np execution time: 0.05866470000000845
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-code-for-pure-python">
<h2><span class="section-number">7.4. </span>The code for pure Python<a class="headerlink" href="#the-code-for-pure-python" title="Permalink to this heading">#</a></h2>
<p><strong>For numpy form, which cannot be translated directly into cython form, we first need to expand it into pure python form.</strong></p>
<p>Expands the above code into a pure python function. It loops through two dimensions for each element in array_1 and finally combines them together. This means that a new object needs to be assigned to each element used.Let’s call it compute_py</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">min_value</span><span class="p">),</span> <span class="n">max_value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_py</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>

    <span class="n">x_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">array_1</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">array_2</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">array_1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_max</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_max</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
            <span class="n">result</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="nb">print</span><span class="p">(</span><span class="n">compute_py</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>

<span class="n">compute_py_time</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">compute_py</span><span class="p">(</span><span class="n">array_1</span><span class="p">,</span> <span class="n">array_2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;compute_py execution time:&quot;</span><span class="p">,</span> <span class="n">compute_py_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 85 127 241 ... 328  52 160]
 [196 160 343 ... 286 127 280]
 [169 109  94 ... 175 214 222]
 ...
 [253 163 325 ...  94 259 229]
 [133 308 190 ... 325 151 202]
 [178 331 281 ...  52 124 263]]
compute_py execution time: 10.784624809999878
</pre></div>
</div>
</div>
</div>
<section id="compare">
<h3><span class="section-number">7.4.1. </span>Compare<a class="headerlink" href="#compare" title="Permalink to this heading">#</a></h3>
<p>Now, we can compare the speed of these two methods.</p>
<p>It is clear that the pure python is much slower than numpy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pure Python&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Speed(s)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">compute_np_time</span><span class="p">,</span> <span class="n">compute_py_time</span><span class="p">],</span>
    <span class="s1">&#39;Percentage(%)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_py_time</span><span class="o">*</span><span class="mi">100</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Creating style functions</span>
<span class="k">def</span> <span class="nf">add_border</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;border: 1px solid black&#39;</span>

<span class="c1"># Applying style functions to data boxes</span>
<span class="n">styled_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">add_border</span><span class="p">)</span>

<span class="c1"># Defining CSS styles</span>
<span class="n">table_style</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;border-collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;collapse&#39;</span><span class="p">)]},</span>
    <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;th, td&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;border&#39;</span><span class="p">,</span> <span class="s1">&#39;1px solid black&#39;</span><span class="p">)]}</span>
<span class="p">]</span>

<span class="c1"># Adding styles to stylised data boxes</span>
<span class="n">styled_df</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">table_style</span><span class="p">)</span>

<span class="c1"># Displaying stylised data boxes in Jupyter Notebook</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">styled_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_53ec3 table {
  border-collapse: collapse;
}
#T_53ec3 th {
  border: 1px solid black;
}
#T_53ec3  td {
  border: 1px solid black;
}
#T_53ec3_row0_col0, #T_53ec3_row0_col1, #T_53ec3_row0_col2, #T_53ec3_row1_col0, #T_53ec3_row1_col1, #T_53ec3_row1_col2 {
  border: 1px solid black;
}
</style>
<table id="T_53ec3">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_53ec3_level0_col0" class="col_heading level0 col0" >Methods</th>
      <th id="T_53ec3_level0_col1" class="col_heading level0 col1" >Speed(s)</th>
      <th id="T_53ec3_level0_col2" class="col_heading level0 col2" >Percentage(%)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_53ec3_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_53ec3_row0_col0" class="data row0 col0" >Numpy</td>
      <td id="T_53ec3_row0_col1" class="data row0 col1" >0.058665</td>
      <td id="T_53ec3_row0_col2" class="data row0 col2" >100.000000</td>
    </tr>
    <tr>
      <th id="T_53ec3_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_53ec3_row1_col0" class="data row1 col0" >Pure Python</td>
      <td id="T_53ec3_row1_col1" class="data row1 col1" >10.784625</td>
      <td id="T_53ec3_row1_col2" class="data row1 col2" >0.543966</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</section>
<section id="the-code-for-cython">
<h2><span class="section-number">7.5. </span>The code for Cython<a class="headerlink" href="#the-code-for-cython" title="Permalink to this heading">#</a></h2>
<section id="cython">
<h3><span class="section-number">7.5.1. </span>Cython<a class="headerlink" href="#cython" title="Permalink to this heading">#</a></h3>
<p>Pure Python is also valid Cython code, so the same code can run in cython</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> cython
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span>
import numpy as np
import timeit

array_1 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
array_2 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
a = 4
b = 3
c = 9

def clip(a, min_value, max_value):
    return min(max(a, min_value), max_value)

def compute_cy(array_1, array_2, a, b, c):

    x_max = array_1.shape[0]
    y_max = array_1.shape[1]

    assert array_1.shape == array_2.shape

    result = np.zeros((x_max, y_max), dtype=array_1.dtype)

    for x in range(x_max):
        for y in range(y_max):
            tmp = clip(array_1[x, y], 2, 10)
            tmp = tmp * a + array_2[x, y] * b
            result[x, y] = tmp + c

    return result

print(compute_cy(array_1, array_2, a, b, c))

compute_cy_time = timeit.timeit(lambda: compute_cy(array_1, array_2, a, b, c), number=10)/10

print(&quot;compute_cy execution time:&quot;, compute_cy_time)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[205  70 121 ... 130  64 304]
 [169 262  85 ... 295 232 181]
 [338 346  79 ... 295 100 139]
 ...
 [241 301 166 ... 193 235 289]
 [120 205 105 ... 223  85 103]
 [178  70  94 ... 109 130  55]]
compute_cy execution time: 8.321111910000036
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h4><span class="section-number">7.5.1.1. </span>Compare<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
<p>Because the C code still does exactly what the Python interpreter does, there’s not much of a difference in speed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pure Python&#39;</span><span class="p">,</span><span class="s1">&#39;Cython&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Speed(s)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">compute_np_time</span><span class="p">,</span> <span class="n">compute_py_time</span><span class="p">,</span> <span class="n">compute_cy_time</span><span class="p">],</span>
    <span class="s1">&#39;Percentage(%)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_py_time</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_cy_time</span><span class="o">*</span><span class="mi">100</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Creating style functions</span>
<span class="k">def</span> <span class="nf">add_border</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;border: 1px solid black&#39;</span>

<span class="c1"># Applying style functions to data boxes</span>
<span class="n">styled_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">add_border</span><span class="p">)</span>

<span class="c1"># Defining CSS styles</span>
<span class="n">table_style</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;border-collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;collapse&#39;</span><span class="p">)]},</span>
    <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;th, td&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;border&#39;</span><span class="p">,</span> <span class="s1">&#39;1px solid black&#39;</span><span class="p">)]}</span>
<span class="p">]</span>

<span class="c1"># Adding styles to stylised data boxes</span>
<span class="n">styled_df</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">table_style</span><span class="p">)</span>

<span class="c1"># Displaying stylised data boxes in Jupyter Notebook</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">styled_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_873e0 table {
  border-collapse: collapse;
}
#T_873e0 th {
  border: 1px solid black;
}
#T_873e0  td {
  border: 1px solid black;
}
#T_873e0_row0_col0, #T_873e0_row0_col1, #T_873e0_row0_col2, #T_873e0_row1_col0, #T_873e0_row1_col1, #T_873e0_row1_col2, #T_873e0_row2_col0, #T_873e0_row2_col1, #T_873e0_row2_col2 {
  border: 1px solid black;
}
</style>
<table id="T_873e0">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_873e0_level0_col0" class="col_heading level0 col0" >Methods</th>
      <th id="T_873e0_level0_col1" class="col_heading level0 col1" >Speed(s)</th>
      <th id="T_873e0_level0_col2" class="col_heading level0 col2" >Percentage(%)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_873e0_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_873e0_row0_col0" class="data row0 col0" >Numpy</td>
      <td id="T_873e0_row0_col1" class="data row0 col1" >0.058665</td>
      <td id="T_873e0_row0_col2" class="data row0 col2" >100.000000</td>
    </tr>
    <tr>
      <th id="T_873e0_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_873e0_row1_col0" class="data row1 col0" >Pure Python</td>
      <td id="T_873e0_row1_col1" class="data row1 col1" >10.784625</td>
      <td id="T_873e0_row1_col2" class="data row1 col2" >0.543966</td>
    </tr>
    <tr>
      <th id="T_873e0_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_873e0_row2_col0" class="data row2 col0" >Cython</td>
      <td id="T_873e0_row2_col1" class="data row2 col1" >8.321112</td>
      <td id="T_873e0_row2_col2" class="data row2 col2" >0.705010</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="check">
<h4><span class="section-number">7.5.1.2. </span>Check<a class="headerlink" href="#check" title="Permalink to this heading">#</a></h4>
<p>We can use %%cython -a, to generate html files.</p>
<p>As shown below, if a line is white, it means that the code generated doesn’t interact with Python, so will run as fast as normal C code. The darker the yellow, the more Python interaction there is in that line. Those yellow lines will usually operate on Python objects, raise exceptions, or do other kinds of higher-level operations than what can easily be translated into simple and fast C code.</p>
<p>So we can use it to check our code, and it lets us know what lines to improve so that it can run as fast as C.</p>
<p><img alt="图片描述" src="_images/Speed_up_Numpy_with_Cython_image_01.png" /></p>
</section>
</section>
<section id="add-types">
<h3><span class="section-number">7.5.2. </span>Add Types<a class="headerlink" href="#add-types" title="Permalink to this heading">#</a></h3>
<p>The first thing we need to do is define the type, we named it <strong>compute_cy_t</strong>. This means that the object passed will be converted to a C type.</p>
<p>With the results we can see that the speed has improved compared to the previous.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> --compile-args=-O3

import numpy as np
import timeit

array_1 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
array_2 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
a = 4
b = 3
c = 9

DTYPE = np.intc   # numpy.intc ---- int. Otherwise,they are implicitly typed as Python objects

cdef int clip(int a, int min_value, int max_value):
    return min(max(a, min_value), max_value)


def compute_cy_t(array_1, array_2, int a, int b, int c):
    cdef Py_ssize_t x_max = array_1.shape[0]
    cdef Py_ssize_t y_max = array_1.shape[1]
    
    assert array_1.shape == array_2.shape
    assert array_1.dtype == DTYPE
    assert array_2.dtype == DTYPE

    result = np.zeros((x_max, y_max), dtype=DTYPE)
    
    cdef int tmp

    cdef Py_ssize_t x, y

    for x in range(x_max):
        for y in range(y_max):

            tmp = clip(array_1[x, y], 2, 10)
            tmp = tmp * a + array_2[x, y] * b
            result[x, y] = tmp + c

    return result

print(compute_cy_t(array_1, array_2, a, b, c))

compute_cy_t_time = timeit.timeit(lambda: compute_cy_t(array_1, array_2, a, b, c), number=10)/10

print(&quot;compute_cy_t execution time:&quot;, compute_cy_t_time)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[100 250 319 ...  63 334 283]
 [191 250 172 ... 346 136 240]
 [298 337 281 ... 139 106 115]
 ...
 [238  97 166 ...  73  70 250]
 [127 289 226 ... 196  73 256]
 [109 217 163 ...  21  41 160]]
compute_cy_t execution time: 5.123431210000126
</pre></div>
</div>
</div>
</div>
</section>
<section id="efficient-indexing-with-memoryviews">
<h3><span class="section-number">7.5.3. </span>Efficient indexing with memoryviews<a class="headerlink" href="#efficient-indexing-with-memoryviews" title="Permalink to this heading">#</a></h3>
<p>Adding types does make the code faster, but not nearly as fast as Numpy.</p>
<p>array_1 and array_2 are still NumPy arrays, so Python objects, and expect Python integers as indexes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tmp</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">array_1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>\
<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">array_2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
<span class="n">result</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>
</div>
<p>Here we pass C int values. So every time Cython reaches this line, it has to convert all the C integers to Python int objects. Since this line is called very often, it outweighs the speed benefits of the pure C loops that were created from the range() earlier.</p>
<p>Furthermore, tmp * a + array_2[x, y] * b returns a Python integer and tmp is a C integer, so Cython has to do type conversions again. In the end those types conversions add up. And made our computation really slow. But this problem can be solved easily by using memoryviews.</p>
<p>memoryviews are C structures that can hold a pointer to the data of a NumPy array and all the necessary buffer metadata to provide efficient and safe access: dimensions, strides, item size, item type information, etc… They also support slices, so they work even if the NumPy array isn’t contiguous in memory. They can be indexed by C integers, thus allowing fast access to the NumPy array data.</p>
<p>Here is how to declare a memoryview of integers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cdef</span> <span class="nb">int</span> <span class="p">[:]</span> <span class="n">foo</span>         <span class="c1"># 1D memoryview</span>
<span class="n">cdef</span> <span class="nb">int</span> <span class="p">[:,</span> <span class="p">:]</span> <span class="n">foo</span>      <span class="c1"># 2D memoryview</span>
<span class="n">cdef</span> <span class="nb">int</span> <span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">foo</span>   <span class="c1"># 3D memoryview</span>
</pre></div>
</div>
<p>Here is how to use them in our code,we named it <strong>compute_cy_m</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span>

import numpy as np
import timeit

array_1 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
array_2 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
a = 4
b = 3
c = 9

DTYPE = np.intc   # numpy.intc ---- int. Otherwise,they are implicitly typed as Python objects

cdef int clip(int a, int min_value, int max_value):
    return min(max(a, min_value), max_value)

def compute_cy_m(int[:, :] array_1, int[:, :] array_2, int a, int b, int c):
     
    cdef Py_ssize_t x_max = array_1.shape[0]
    cdef Py_ssize_t y_max = array_1.shape[1]

    assert tuple(array_1.shape) == tuple(array_2.shape)

    result = np.zeros((x_max, y_max), dtype=DTYPE)
    cdef int[:, :] result_view = result

    cdef int tmp
    cdef Py_ssize_t x, y

    for x in range(x_max):
        for y in range(y_max):

            tmp = clip(array_1[x, y], 2, 10)
            tmp = tmp * a + array_2[x, y] * b
            result_view[x, y] = tmp + c

    return result

print(compute_cy_m(array_1, array_2, a, b, c))

compute_cy_m_time = timeit.timeit(lambda: compute_cy_m(array_1, array_2, a, b, c), number=10)/10

print(&quot;compute_cy_m execution time:&quot;, compute_cy_m_time)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[235 173 139 ... 133  82 286]
 [301 322 256 ...  91  36 235]
 [343  85 235 ... 317 283 190]
 ...
 [ 55  76 253 ... 193 217 235]
 [292 238 292 ... 199 103 301]
 [133 124 289 ...  68 232 310]]
compute_cy_m execution time: 0.037777249999999186
</pre></div>
</div>
</div>
</div>
<p>Here we can see how much faster it has become。</p>
</section>
<section id="tuning-indexing-further">
<h3><span class="section-number">7.5.4. </span>Tuning indexing further<a class="headerlink" href="#tuning-indexing-further" title="Permalink to this heading">#</a></h3>
<p>The array lookups are still slowed down by two factors:</p>
<p>Bounds checking is performed.</p>
<p>Negative indices are checked for and handled correctly. The code above is explicitly coded so that it doesn’t use negative indices, and it (hopefully) always access within bounds.</p>
<p>With decorators, we can deactivate those checks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">cimport</span> <span class="n">cython</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Deactivate bounds checking</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>   <span class="c1"># Deactivate negative indexing.</span>
<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">array_1</span><span class="p">,</span> <span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">array_2</span><span class="p">,</span> <span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">c</span><span class="p">):</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Note that these lines of code are to be placed above the specified function, not at the beginning.Here we named it <strong>compute_cy_i</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span>

import numpy as np
import timeit


array_1 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
array_2 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
a = 4
b = 3
c = 9

DTYPE = np.intc   # numpy.intc ---- int. Otherwise,they are implicitly typed as Python objects

cdef int clip(int a, int min_value, int max_value):
    return min(max(a, min_value), max_value)

cimport cython
@cython.boundscheck(False)  # Deactivate bounds checking.
@cython.wraparound(False)   # Deactivate negative indexing.

def compute_cy_i(int[:, :] array_1, int[:, :] array_2, int a, int b, int c):
     
    cdef Py_ssize_t x_max = array_1.shape[0]
    cdef Py_ssize_t y_max = array_1.shape[1]

    assert tuple(array_1.shape) == tuple(array_2.shape)

    result = np.zeros((x_max, y_max), dtype=DTYPE)
    cdef int[:, :] result_view = result

    cdef int tmp
    cdef Py_ssize_t x, y

    for x in range(x_max):
        for y in range(y_max):

            tmp = clip(array_1[x, y], 2, 10)
            tmp = tmp * a + array_2[x, y] * b
            result_view[x, y] = tmp + c

    return result

print(compute_cy_i(array_1, array_2, a, b, c))

compute_cy_i_time = timeit.timeit(lambda: compute_cy_i(array_1, array_2, a, b, c), number=10)/10

print(&quot;compute_cy_i execution time:&quot;, compute_cy_i_time)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[187 259  94 ...  79 190 142]
 [154 178 175 ... 304 217 307]
 [106 331 346 ... 313 103 130]
 ...
 [ 85 280 313 ... 208  73  85]
 [298 256  85 ... 274 260 247]
 [ 82 322 244 ... 241 157 181]]
compute_cy_i execution time: 0.014358759999959147
</pre></div>
</div>
</div>
</div>
</section>
<section id="declaring-the-numpy-arrays-as-contiguous">
<h3><span class="section-number">7.5.5. </span>Declaring the NumPy arrays as contiguous<a class="headerlink" href="#declaring-the-numpy-arrays-as-contiguous" title="Permalink to this heading">#</a></h3>
<p>For extra speed gains, if you know that the NumPy arrays you are providing are contiguous in memory, you can declare the memoryview as contiguous.</p>
<p>We give an example on an array that has 3 dimensions. If you want to give Cython the information that the data is C-contiguous you have to declare the memoryview like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cdef</span> <span class="nb">int</span> <span class="p">[:,:,::</span><span class="mi">1</span><span class="p">]</span> <span class="n">a</span>
</pre></div>
</div>
<p>If you want to give Cython the information that the data is Fortran-contiguous you have to declare the memoryview like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cdef</span> <span class="nb">int</span> <span class="p">[::</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">a</span>
</pre></div>
</div>
<p>If all this makes no sense to you, you can skip this part, declaring arrays as contiguous constrains the usage of your functions as it rejects array slices as input.</p>
<p>Here we named it <strong>compute_cy_c</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> 

import numpy as np
import timeit


array_1 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
array_2 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
a = 4
b = 3
c = 9

DTYPE = np.intc   # numpy.intc ---- int. Otherwise,they are implicitly typed as Python objects

cdef int clip(int a, int min_value, int max_value):
    return min(max(a, min_value), max_value)

cimport cython
@cython.boundscheck(False)  # Deactivate bounds checking.
@cython.wraparound(False)   # Deactivate negative indexing.

def compute_cy_c(int[:, ::1] array_1, int[:, ::1] array_2, int a, int b, int c):
     
    cdef Py_ssize_t x_max = array_1.shape[0]
    cdef Py_ssize_t y_max = array_1.shape[1]

    assert tuple(array_1.shape) == tuple(array_2.shape)

    result = np.zeros((x_max, y_max), dtype=DTYPE)
    cdef int[:, ::1] result_view = result

    cdef int tmp
    cdef Py_ssize_t x, y

    for x in range(x_max):
        for y in range(y_max):

            tmp = clip(array_1[x, y], 2, 10)
            tmp = tmp * a + array_2[x, y] * b
            result_view[x, y] = tmp + c

    return result

print(compute_cy_c(array_1, array_2, a, b, c))

compute_cy_c_time = timeit.timeit(lambda: compute_cy_c(array_1, array_2, a, b, c), number=10)/10

print(&quot;compute_cy_c execution time:&quot;, compute_cy_c_time)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[283 109 244 ...  58  61 328]
 [ 85 142 331 ... 145 346 259]
 [202 235 109 ... 169 280  52]
 ...
 [325 232 271 ... 151  87 202]
 [ 52  73 295 ... 247 235 286]
 [232 268 127 ... 196 136 211]]
compute_cy_c execution time: 0.014614970000002359
</pre></div>
</div>
</div>
</div>
<p>Obviously, this optimization doesn’t work here.</p>
</section>
<section id="making-the-function-cleaner-use-of-multiple-data-types">
<h3><span class="section-number">7.5.6. </span>Making the function cleaner &amp; Use of multiple data types<a class="headerlink" href="#making-the-function-cleaner-use-of-multiple-data-types" title="Permalink to this heading">#</a></h3>
<p>Declaring types can make your code quite verbose. If you don’t mind Cython inferring the C types of your variables, you can use the following compiler directive at the top of the file. It will save you quite a bit of typing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">infer_types</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
<p>Note that since type declarations must happen at the top indentation level, Cython won’t infer the type of variables declared for the first time in other indentation levels. It would change too much the meaning of our code. This is why, we must still declare manually the type of the tmp, x and y variable.</p>
<p>And actually, manually giving the type of the tmp variable will be useful when using fused types.</p>
<p>All those speed gains are nice, but adding types constrains our code. At the moment, it would mean that our function can only work with NumPy arrays with the np.intc type.</p>
<p>So we can use fused types to make our code work with multiple NumPy data types. The code is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctypedef</span> <span class="n">fused</span> <span class="n">my_type</span><span class="p">:</span>
    <span class="nb">int</span>
    <span class="n">double</span>
    <span class="n">long</span> <span class="n">long</span>
</pre></div>
</div>
<p>It is similar to a C++ template. It generates multiple function declarations at compile time and then selects the correct function at runtime based on the types of arguments provided. By comparing the types in the if-conditions, it is also possible to execute a completely different code path depending on the specific data type.</p>
<p>In our example, since we can no longer access the dtype of NumPy’s input array, we use these if-else statements to know what NumPy data type should be used for our output array.</p>
<p>In this case, our function now applies to ints, doubles and floats.Here we named it <strong>compute_cy_mdt</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> 

# cython: infer_types=True
import numpy as np
import timeit
cimport cython

array_1 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
array_2 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
a = 4
b = 3
c = 9

ctypedef fused my_type:
    int
    double
    long long

cdef my_type clip(my_type a, my_type min_value, my_type max_value):
    return min(max(a, min_value), max_value)

@cython.boundscheck(False)
@cython.wraparound(False)
def compute_cy_mdt(my_type[:, ::1] array_1, my_type[:, ::1] array_2, my_type a, my_type b, my_type c):
     
    x_max = array_1.shape[0]
    y_max = array_1.shape[1]
    
    assert tuple(array_1.shape) == tuple(array_2.shape)

    if my_type is int:
        dtype = np.intc
    elif my_type is double:
        dtype = np.double
    elif my_type is cython.longlong:
        dtype = np.longlong

    result = np.zeros((x_max, y_max), dtype=dtype)
    cdef my_type[:, ::1] result_view = result

    cdef my_type tmp
    cdef Py_ssize_t x, y

    for x in range(x_max):
        for y in range(y_max):

            tmp = clip(array_1[x, y], 2, 10)
            tmp = tmp * a + array_2[x, y] * b
            result_view[x, y] = tmp + c

    return result

print(compute_cy_mdt(array_1, array_2, a, b, c))

compute_cy_mdt_time = timeit.timeit(lambda: compute_cy_mdt(array_1, array_2, a, b, c), number=10)/10

print(&quot;compute_cy_mdt execution time:&quot;, compute_cy_mdt_time)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[109 337 268 ...  55 316 184]
 [226 157 310 ... 274 273 258]
 [256 328  61 ...  82 241 259]
 ...
 [154 274 328 ... 340 262 217]
 [304 100  55 ... 256 334 148]
 [ 58 170 289 ... 226 274  91]]
compute_cy_mdt execution time: 0.014951370000017051
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-multiple-threads">
<h3><span class="section-number">7.5.7. </span>Using multiple threads<a class="headerlink" href="#using-multiple-threads" title="Permalink to this heading">#</a></h3>
<p>Cython has support for OpenMP. It also has some nice wrappers around it, like the function prange().</p>
<p>The GIL must be released, so this is why we declare our clip() function nogil.</p>
<p>Here we named it <strong>compute_cy_mt.</strong></p>
<p><strong>Note:</strong>
The important thing to note here is that we need to open openmp, this may be different for different operating systems, I’m running this on windows so here is: -c=/openmp</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> --force -c=/openmp
# tag: openmp
# You can ignore the previous line.
# It&#39;s for internal testing of the cython documentation.

# distutils: extra_compile_args=-fopenmp
# distutils: extra_link_args=-fopenmp

import numpy as np
import timeit
cimport cython
from cython.parallel import prange

array_1 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
array_2 = np.random.uniform(0, 100, size=(3000, 2000)).astype(np.intc)
a = 4
b = 3
c = 9

ctypedef fused my_type:
    int
    double
    long long


# We declare our plain c function nogil
cdef my_type clip(my_type a, my_type min_value, my_type max_value) nogil:
    return min(max(a, min_value), max_value)


@cython.boundscheck(False)
@cython.wraparound(False)
def compute_cy_mt(my_type[:, ::1] array_1, my_type[:, ::1] array_2, my_type a, my_type b, my_type c):

    cdef Py_ssize_t x_max = array_1.shape[0]
    cdef Py_ssize_t y_max = array_1.shape[1]

    assert tuple(array_1.shape) == tuple(array_2.shape)

    if my_type is int:
        dtype = np.intc
    elif my_type is double:
        dtype = np.double
    elif my_type is cython.longlong:
        dtype = np.longlong

    result = np.zeros((x_max, y_max), dtype=dtype)
    cdef my_type[:, ::1] result_view = result

    cdef my_type tmp
    cdef Py_ssize_t x, y

    # We use prange here.
    # for x in prange(x_max, nogil=True):
    #     for y in range(y_max):
    for x in range(x_max):
        for y in prange(y_max, num_threads=4,nogil=True):
            tmp = clip(array_1[x, y], 2, 10)
            tmp = tmp * a + array_2[x, y] * b
            result_view[x, y] = tmp + c

    return result

print(compute_cy_mt(array_1, array_2, a, b, c))

compute_cy_mt_time = timeit.timeit(lambda: compute_cy_mt(array_1, array_2, a, b, c), number=10)/10

print(&quot;compute_cy_mt execution time:&quot;, compute_cy_mt_time)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[274 322 337 ... 280 192 262]
 [130 200 277 ... 121 307 304]
 [ 76 124  59 ... 184 256 265]
 ...
 [169  38 340 ... 175 247 328]
 [325 337 319 ... 180 328 283]
 [252  97 285 ... 193  69 169]]
compute_cy_mt execution time: 0.04007001999998465
</pre></div>
</div>
</div>
</div>
<p>Parallel computing does not necessarily lead to an eventual speed increase, and the reasons for this can be varied. For example, Parallelizing operations incurs additional overhead, such as thread creation and synchronization, that may outweigh the benefits of parallelism for small or simple operations.</p>
<p>Here, instead, I am running slower, which could be that this example is not applicable to parallel computing or is not adapted to my hardware.</p>
</section>
</section>
<section id="summarize">
<h2><span class="section-number">7.6. </span>Summarize<a class="headerlink" href="#summarize" title="Permalink to this heading">#</a></h2>
<section id="html-file">
<h3><span class="section-number">7.6.1. </span>html file<a class="headerlink" href="#html-file" title="Permalink to this heading">#</a></h3>
<p>The final html file is as follows. Most of the lines have become lighter in colour, even white.</p>
<p><img alt="图片描述" src="_images/Speed_up_Numpy_with_Cython_image_02.png" /></p>
</section>
<section id="id2">
<h3><span class="section-number">7.6.2. </span>Compare<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<p>Finally let’s compare their speeds. If we look at Numpy’s speed as 100%, then the last column is their comparison with the very first Numpy speed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pure Python&#39;</span><span class="p">,</span><span class="s1">&#39;Original Cython&#39;</span><span class="p">,</span><span class="s1">&#39;Cython_add types&#39;</span><span class="p">,</span><span class="s1">&#39;Cython_memoryviews&#39;</span><span class="p">,</span><span class="s1">&#39;Cython_tuning indexing&#39;</span><span class="p">,</span><span class="s1">&#39;Cyton_contiguous&#39;</span><span class="p">,</span><span class="s1">&#39;Cython_multiple data types&#39;</span><span class="p">,</span><span class="s1">&#39;Cython_multiple threads&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Speed(s)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">compute_np_time</span><span class="p">,</span> <span class="n">compute_py_time</span><span class="p">,</span><span class="n">compute_cy_time</span><span class="p">,</span><span class="n">compute_cy_t_time</span><span class="p">,</span><span class="n">compute_cy_m_time</span><span class="p">,</span><span class="n">compute_cy_i_time</span><span class="p">,</span><span class="n">compute_cy_c_time</span><span class="p">,</span><span class="n">compute_cy_mdt_time</span><span class="p">,</span><span class="n">compute_cy_mt_time</span><span class="p">],</span>
    <span class="s1">&#39;Percentage(%)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_py_time</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_cy_time</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_cy_t_time</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_cy_m_time</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_cy_i_time</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_cy_c_time</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_cy_mdt_time</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">compute_np_time</span><span class="o">/</span><span class="n">compute_cy_mt_time</span><span class="o">*</span><span class="mi">100</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Creating style functions</span>
<span class="k">def</span> <span class="nf">add_border</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;border: 1px solid black&#39;</span>

<span class="c1"># Applying style functions to data boxes</span>
<span class="n">styled_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">add_border</span><span class="p">)</span>

<span class="c1"># Defining CSS styles</span>
<span class="n">table_style</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;border-collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;collapse&#39;</span><span class="p">)]},</span>
    <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;th, td&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;border&#39;</span><span class="p">,</span> <span class="s1">&#39;1px solid black&#39;</span><span class="p">)]}</span>
<span class="p">]</span>

<span class="c1"># Adding styles to stylised data boxes</span>
<span class="n">styled_df</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">table_style</span><span class="p">)</span>

<span class="c1"># Displaying stylised data boxes in Jupyter Notebook</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">styled_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_0de2c table {
  border-collapse: collapse;
}
#T_0de2c th {
  border: 1px solid black;
}
#T_0de2c  td {
  border: 1px solid black;
}
#T_0de2c_row0_col0, #T_0de2c_row0_col1, #T_0de2c_row0_col2, #T_0de2c_row1_col0, #T_0de2c_row1_col1, #T_0de2c_row1_col2, #T_0de2c_row2_col0, #T_0de2c_row2_col1, #T_0de2c_row2_col2, #T_0de2c_row3_col0, #T_0de2c_row3_col1, #T_0de2c_row3_col2, #T_0de2c_row4_col0, #T_0de2c_row4_col1, #T_0de2c_row4_col2, #T_0de2c_row5_col0, #T_0de2c_row5_col1, #T_0de2c_row5_col2, #T_0de2c_row6_col0, #T_0de2c_row6_col1, #T_0de2c_row6_col2, #T_0de2c_row7_col0, #T_0de2c_row7_col1, #T_0de2c_row7_col2, #T_0de2c_row8_col0, #T_0de2c_row8_col1, #T_0de2c_row8_col2 {
  border: 1px solid black;
}
</style>
<table id="T_0de2c">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_0de2c_level0_col0" class="col_heading level0 col0" >Methods</th>
      <th id="T_0de2c_level0_col1" class="col_heading level0 col1" >Speed(s)</th>
      <th id="T_0de2c_level0_col2" class="col_heading level0 col2" >Percentage(%)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_0de2c_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_0de2c_row0_col0" class="data row0 col0" >Numpy</td>
      <td id="T_0de2c_row0_col1" class="data row0 col1" >0.058665</td>
      <td id="T_0de2c_row0_col2" class="data row0 col2" >100.000000</td>
    </tr>
    <tr>
      <th id="T_0de2c_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_0de2c_row1_col0" class="data row1 col0" >Pure Python</td>
      <td id="T_0de2c_row1_col1" class="data row1 col1" >10.784625</td>
      <td id="T_0de2c_row1_col2" class="data row1 col2" >0.543966</td>
    </tr>
    <tr>
      <th id="T_0de2c_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_0de2c_row2_col0" class="data row2 col0" >Original Cython</td>
      <td id="T_0de2c_row2_col1" class="data row2 col1" >8.321112</td>
      <td id="T_0de2c_row2_col2" class="data row2 col2" >0.705010</td>
    </tr>
    <tr>
      <th id="T_0de2c_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_0de2c_row3_col0" class="data row3 col0" >Cython_add types</td>
      <td id="T_0de2c_row3_col1" class="data row3 col1" >5.123431</td>
      <td id="T_0de2c_row3_col2" class="data row3 col2" >1.145028</td>
    </tr>
    <tr>
      <th id="T_0de2c_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_0de2c_row4_col0" class="data row4 col0" >Cython_memoryviews</td>
      <td id="T_0de2c_row4_col1" class="data row4 col1" >0.037777</td>
      <td id="T_0de2c_row4_col2" class="data row4 col2" >155.291081</td>
    </tr>
    <tr>
      <th id="T_0de2c_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_0de2c_row5_col0" class="data row5 col0" >Cython_tuning indexing</td>
      <td id="T_0de2c_row5_col1" class="data row5 col1" >0.014359</td>
      <td id="T_0de2c_row5_col2" class="data row5 col2" >408.563831</td>
    </tr>
    <tr>
      <th id="T_0de2c_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_0de2c_row6_col0" class="data row6 col0" >Cyton_contiguous</td>
      <td id="T_0de2c_row6_col1" class="data row6 col1" >0.014615</td>
      <td id="T_0de2c_row6_col2" class="data row6 col2" >401.401440</td>
    </tr>
    <tr>
      <th id="T_0de2c_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_0de2c_row7_col0" class="data row7 col0" >Cython_multiple data types</td>
      <td id="T_0de2c_row7_col1" class="data row7 col1" >0.014951</td>
      <td id="T_0de2c_row7_col2" class="data row7 col2" >392.370064</td>
    </tr>
    <tr>
      <th id="T_0de2c_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_0de2c_row8_col0" class="data row8 col0" >Cython_multiple threads</td>
      <td id="T_0de2c_row8_col1" class="data row8 col1" >0.040070</td>
      <td id="T_0de2c_row8_col2" class="data row8 col2" >146.405467</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We can see that the final optimisation is already more than three times faster than the Numpy.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="06_Learn-how-to-use-cython.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">6. </span>Learn how to use cython</p>
      </div>
    </a>
    <a class="right-next"
       href="08_Speed-up-2D-particles-with-Cython.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">8. </span>Speed up 2D particles with Cython</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduce">7.1. Introduce</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-random-arrays">7.2. Generating random arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-code-for-the-nump">7.3. The code for the Nump</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-code-for-pure-python">7.4. The code for pure Python</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compare">7.4.1. Compare</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-code-for-cython">7.5. The code for Cython</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cython">7.5.1. Cython</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">7.5.1.1. Compare</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check">7.5.1.2. Check</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-types">7.5.2. Add Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#efficient-indexing-with-memoryviews">7.5.3. Efficient indexing with memoryviews</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tuning-indexing-further">7.5.4. Tuning indexing further</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declaring-the-numpy-arrays-as-contiguous">7.5.5. Declaring the NumPy arrays as contiguous</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-the-function-cleaner-use-of-multiple-data-types">7.5.6. Making the function cleaner &amp; Use of multiple data types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-multiple-threads">7.5.7. Using multiple threads</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summarize">7.6. Summarize</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#html-file">7.6.1. html file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">7.6.2. Compare</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sen Liu
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>